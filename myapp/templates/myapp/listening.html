{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Listening Test</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">

<h1 class="text-3xl font-bold mb-6 text-red-600">Listening Test</h1>

<div class="mb-4">
    <button id="newTestBtn" class="bg-red-600 text-white px-6 py-2 rounded">ðŸŽ§ Start New Test</button>
</div>

<!-- TIMER -->
<div class="text-center mb-6">
    <div id="timerDisplay" class="text-4xl font-bold">00:00</div>
</div>

<!-- AUDIO -->
<div id="audioBox" class="hidden bg-white p-4 rounded shadow mb-4">
    <h2 id="audioTitle" class="text-xl font-bold mb-2"></h2>
    <audio id="audioPlayer" controls class="w-full"></audio>
</div>

<!-- QUESTIONS -->
<div id="questionsBox" class="hidden bg-white p-6 rounded shadow mb-4">
    <h2 class="text-2xl font-bold mb-4">Questions</h2>
    <div id="questionsArea"></div>
    <form action="{% url 'save_test_score' 'listening' %}" method="POST">
    {% csrf_token %}
    <input type="hidden" name="score" id="scoreInput">
    <button id="submitBtn" class="mt-4 bg-green-600 text-white px-6 py-2 rounded">Submit Test</button>
</form>
</div>

<!-- SCORE -->
<div id="scoreBox" class="hidden bg-white p-4 rounded shadow text-lg font-semibold"></div>

<script>
const AUDIO_FILES = [
    {id:1, title:"Audio 1", src:"{% static 'audio/CGtoIELTS_01.mp3' %}"},
    {id:2, title:"Audio 2", src:"{% static 'audio/CGtoIELTS_02.mp3' %}"},
    {id:3, title:"Audio 3", src:"{% static 'audio/CGtoIELTS_03.mp3' %}"},
    {id:4, title:"Audio 4", src:"{% static 'audio/CGtoIELTS_04.mp3' %}"},
    {id:5, title:"Audio 5", src:"{% static 'audio/CGtoIELTS_05.mp3' %}"},
    {id:6, title:"Audio 6", src:"{% static 'audio/CGtoIELTS_06.mp3' %}"},
    {id:7, title:"Audio 7", src:"{% static 'audio/CGtoIELTS_07.mp3' %}"},
    {id:8, title:"Audio 8", src:"{% static 'audio/CGtoIELTS_08.mp3' %}"},
    {id:9, title:"Audio 9", src:"{% static 'audio/CGtoIELTS_09.mp3' %}"},
    {id:10, title:"Audio 10", src:"{% static 'audio/CGtoIELTS_10.mp3' %}"}
];

let timer = 0;
let timerInterval = null;
const timerDisplay = document.getElementById("timerDisplay");

function startTimer() {
    timer = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timer++;
        let m = String(Math.floor(timer / 60)).padStart(2, "0");
        let s = String(timer % 60).padStart(2, "0");
        timerDisplay.textContent = `${m}:${s}`;
    }, 1000);
}

function stopTimer(){
    clearInterval(timerInterval);
}

document.getElementById("newTestBtn").onclick = () => {
    startTimer();
    
    let audio = AUDIO_FILES[Math.floor(Math.random() * AUDIO_FILES.length)];

    document.getElementById("audioBox").classList.remove("hidden");
    document.getElementById("questionsBox").classList.remove("hidden");

    document.getElementById("audioTitle").textContent = audio.title;
    document.getElementById("audioPlayer").src = audio.src;

    generateQuestions(audio.id);
};

function generateQuestions(audioId) {
    let qArea = document.getElementById("questionsArea");
    qArea.innerHTML = "";

    const templates = [
        {q:"What is the main topic?", a:"topic-"+audioId},
        {q:"Who is mentioned?", a:"person-"+audioId},
        {q:"Which place is talked about?", a:"place-"+audioId},
        {q:"What time/date is mentioned?", a:"time-"+audioId}
    ];

    templates.forEach((t, index) => {
        let correct = t.a;

        let options = [
            correct,
            correct + "-1",
            correct + "-2",
            correct + "-3"
        ].sort(() => Math.random() - 0.5);

        let html = `
            <div class="mb-4">
                <p class="font-semibold">Q${index+1}. ${t.q}</p>
                ${options.map(o => `
                    <label class="block">
                        <input type="radio" name="q${index}" value="${o}"> ${o}
                    </label>`).join("")}
            </div>
        `;
        qArea.innerHTML += html;
    });
}

document.getElementById("submitBtn").onclick = () => {
    stopTimer();
    let correct = 0;

    for(let i=0; i<4; i++){
        let selected = document.querySelector(`input[name="q${i}"]:checked`);
        if(!selected) continue;

        let correctAnswer = document.querySelector(`input[name="q${i}"]`).value.split("-")[0] + "-" + AUDIO_FILES[0].id;
        
        if(selected.value.includes("topic") || selected.value.includes("person")) correct++;
    }

    document.getElementById("scoreBox").classList.remove("hidden");
    document.getElementById("scoreBox").textContent =
        `You scored ${correct} / 4 in ${timerDisplay.textContent}`;
};
</script>

</body>
</html>
